---
- name: Hospital Management System Deployment
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    k8s_manifest_path: "../k8s/hospital-deployment.yaml"
    frontend_nodeport: 30082
    backend_nodeport: 30083

  tasks:
    - name: Gather system facts
      ansible.builtin.setup:

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Start Minikube
      shell: |
        if ! minikube status 2>/dev/null | grep -q "Running"; then
          minikube start --driver=docker --memory=2000 --cpus=2
        fi
      args:
        executable: /bin/bash

    - name: Copy Kubernetes deployment file
      ansible.builtin.copy:
        src: "{{ k8s_manifest_path }}"
        dest: /tmp/hospital-deployment.yaml
        force: yes

    - name: Apply Kubernetes manifests
      shell: kubectl apply -f /tmp/hospital-deployment.yaml
      args:
        executable: /bin/bash

    - name: Wait for pods
      shell: kubectl get pods --no-headers | grep -v Running || true
      register: pod_status
      until: pod_status.stdout == ""
      retries: 20
      delay: 10
      args:
        executable: /bin/bash

    - name: Display services
      shell: kubectl get svc
      register: svc_output
      args:
        executable: /bin/bash

    - name: Print services
      debug:
        msg: "{{ svc_output.stdout }}"

    - name: Show URLs
      debug:
        msg:
        - "Frontend: http://localhost:{{ frontend_nodeport }}/"
        - "Backend: http://localhost:{{ backend_nodeport }}/"
